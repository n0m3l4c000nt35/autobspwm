#!/bin/bash

green="\e[0;32m\033[1m"
red="\e[0;31m\033[1m"
blue="\e[0;34m\033[1m"
yellow="\e[0;33m\033[1m"
purple="\e[0;35m\033[1m"
turquoise="\e[0;36m\033[1m"
gray="\e[0;37m\033[1m"
end="\033[0m\e[0m"

# Función para verificar si un comando se ejecutó correctamente
check_command() {
    if [ $? -eq 0 ]; then
        echo -e "\n${green}[OK]${end} $1"
    else
        echo -e "\n${red}[ERROR]${end} $1"
        exit 1
    fi
}

install_bspwm() {
    echo -e "\n${green}[+]${end} Instalando bspwm...\n"
    sudo apt install libxcb-xinerama0-dev libxcb-icccm4-dev libxcb-randr0-dev libxcb-util0-dev libxcb-ewmh-dev libxcb-keysyms1-dev libxcb-shape0-dev -y
    check_command "Instalación de dependencias de bspwm"
    git clone https://github.com/baskerville/bspwm.git ~/Downloads/bspwm
    git clone https://github.com/baskerville/sxhkd.git ~/Downloads/sxhkd
    cd bspwm
    sudo -C ~/Downloads/bspwm
    sudo -C ~/Downloads/bspwm install
    check_command "Instalación de bspwm"
    which bspwm
    check_command "Verificación de la instalación de bspwm"
}

install_sxhkd() {
    echo -e "\n${green}[+]${end} Instalando sxhkd...\n"
    cd ~/Downloads/sxhkd
    sudo -C ~/Downloads/sxhkd
    sudo -C ~/Downloads/sxhkd install
    check_command "Instalación de sxhkd"
    which sxhkd
    check_command "Verificación de la instalación sxhkd"
}

configure_bspwm_sxhkd() {
    echo -e "\n${green}[+]${end} Configurando bspwm y sxhkd...\n"
    cp ~/Downloads/bspwm/examples/bspwmrc ~/.config/bspwm/
    chmod u+x ~/.config/bspwm/bspwmrc
    sudo apt install bspwm -y
    cp ~/Downloads/bspwm/examples/sxhkdrc ~/.config/sxhkd/
    check_command "Configuración inicial de bspwm y sxhkd"

    # Modificar sxhkdrc
    sed -i 's/super + {h,j,k,l}/super + {Left,Down,Up,Right}/g' ~/.config/sxhkd/sxhkdrc
    sed -i 's/super + ctrl + {h,j,k,l}/super + ctrl + alt + {Left,Down,Up,Right}/g' ~/.config/sxhkd/sxhkdrc
    sed -i 's/super + alt + {h,j,k,l}/super + alt + shift + {Left,Down,Up,Right}/g' ~/.config/sxhkd/sxhkdrc
    echo -e "\n# custom resize\nsuper + alt + {Left,Down,Up,Right}\n    ~/.config/bspwm/scripts/bspwm_resize {west,south,north,east}" >> ~/.config/sxhkd/sxhkdrc
    check_command "Modificación de sxhkd"

    # Crear script bspwm_resize
    mkdir -p ~/.config/bspwm/scripts
    cat << EOF > ~/.config/bspwm/scripts/bspwm_resize
#!/usr/bin/env dash

if bspc query -N -n focused.floating > /dev/null; then
    step=20
else
    step=100
fi

case "\$1" in
    west) dir=right; falldir=left; x="-\$step"; y=0;;
    east) dir=right; falldir=left; x="\$step"; y=0;;
    north) dir=top; falldir=bottom; x=0; y="-\$step";;
    south) dir=top; falldir=bottom; x=0; y="\$step";;
esac

bspc node -z "\$dir" "\$x" "\$y" || bspc node -z "\$falldir" "\$x" "\$y"
EOF
    chmod +x ~/.config/bspwm/scripts/bspwm_resize
    check_command "Creación del script bspwm_resize"

    # Agregar configuración para VMware
    echo "vmware-user-suid-wrapper &" >> ~/.config/bspwm/bspwmrc
    check_command "Configuración para VMware"

    # Agregar atajo para Firefox
    echo -e "\n# open firefox\nsuper + shift + f\n    /usr/bin/firefox" >> ~/.config/sxhkd/sxhkdrc
    check_command "Atajo para Firefox añadido"
}

# Actualizar el sistema
# sudo apt update && sudo apt upgrade -y
# check_command "Actualización del sistema

# Instalar dependencias básicas
sudo apt install git wget curl build-essential -y
check_command "Instalación de dependencias básicas"

# Crear directorios necesarios
mkdir -p ~/.config/{bspwm,sxhkd,kitty,picom,polybar}
check_command "Creación de directorios de configuración"

# Función principal
main() {
    echo -e "\n${green}[+]${end} Comenzando la personalización del sistema..."
    install_bspwm
    install_sxhkd
    configure_bspwm_sxhkd
}

# Ejecutar la función principal
main
